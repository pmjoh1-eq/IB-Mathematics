<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IB AA Term Planner – Topic 1: Number & Algebra</title>
  <style>
    :root {
      /* Default = dark theme */
      --bg: #020617;
      --bg-alt: #0b1120;
      --panel-bg: #020617;
      --card-bg: #020617;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.16);
      --accent-blue: #38bdf8;
      --accent-purple: #a855f7;
      --border-subtle: rgba(148, 163, 184, 0.45);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
    }

    /* Light theme overrides */
    body[data-theme="light"] {
      --bg: #e5e7eb;
      --bg-alt: #f9fafb;
      --panel-bg: #ffffff;
      --card-bg: #ffffff;
      --accent: #16a34a;
      --accent-soft: rgba(22, 163, 74, 0.16);
      --accent-blue: #0284c7;
      --accent-purple: #7c3aed;
      --border-subtle: rgba(148, 163, 184, 0.6);
      --text-main: #0f172a;
      --text-muted: #6b7280;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, var(--bg-alt) 0, var(--bg) 55%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 1rem 1.5rem 0.5rem;
      border-bottom: 1px solid var(--border-subtle);
      background: linear-gradient(
        to bottom,
        rgba(15, 23, 42, 0.96),
        rgba(15, 23, 42, 0.82)
      );
      backdrop-filter: blur(16px);
      position: sticky;
      top: 0;
      z-index: 20;
      color: #e5e7eb;
    }

    body[data-theme="light"] header {
      background: linear-gradient(
        to bottom,
        rgba(15, 23, 42, 0.9),
        rgba(15, 23, 42, 0.85)
      );
      color: #f9fafb;
    }

    h1 {
      margin: 0;
      font-size: 1.2rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
    }

    .badge {
      font-size: 0.75rem;
      padding: 0.1rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      color: #e5e7eb;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-top: 0.15rem;
      background: rgba(15, 23, 42, 0.7);
    }

    .term-tabs {
      margin-top: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .term-tab {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 0.25rem 0.7rem;
      font-size: 0.8rem;
      background: rgba(15, 23, 42, 0.8);
      color: var(--text-muted);
      cursor: pointer;
    }

    .term-tab.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: #bbf7d0;
    }

    .header-controls {
      margin-top: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      font-size: 0.75rem;
      color: #e5e7eb;
    }

    .header-controls code {
      background: rgba(15, 23, 42, 0.7);
      padding: 0.1rem 0.35rem;
      border-radius: 0.25rem;
    }

    .header-actions {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.35rem;
      flex-wrap: wrap;
    }

    #summaryLabel {
      opacity: 0.85;
    }

    button {
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 0.3rem 0.75rem;
      font-size: 0.8rem;
      background: #020617;
      color: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    button.primary {
      border-color: var(--accent);
      background: radial-gradient(
        circle at top left,
        rgba(34, 197, 94, 0.3),
        #020617
      );
      color: #ecfdf5;
    }

    button:hover {
      border-color: var(--accent);
    }

    body[data-theme="light"] button {
      background: #0f172a;
      color: #e5e7eb;
    }

    main {
      flex: 1;
      display: flex;
      gap: 1rem;
      padding: 1rem 1.5rem 1.5rem;
    }

    /* Left: syllabus + resources */
    .left-column {
      width: 320px;
      min-width: 260px;
      max-width: 360px;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      position: sticky;
      top: 110px; /* below header */
      align-self: flex-start;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
    }

    /* Right: textbook references */
    .right-column {
      width: 280px;
      min-width: 260px;
      max-width: 340px;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      position: sticky;
      top: 110px;
      align-self: flex-start;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
    }

    .panel {
      background: var(--panel-bg);
      border-radius: 1rem;
      border: 1px solid var(--border-subtle);
      padding: 0.75rem;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.75);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    body[data-theme="light"] .panel {
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.25);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .panel-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .panel-subtitle {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .backlog-dropzone {
      margin-top: 0.25rem;
      border-radius: 0.75rem;
      border: 1px dashed rgba(148, 163, 184, 0.6);
      min-height: 80px;
      max-height: 300px;
      overflow-y: auto;
      padding: 0.4rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      background: var(--bg-alt);
    }

    .backlog-dropzone::-webkit-scrollbar,
    .planner-grid::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    .backlog-dropzone::-webkit-scrollbar-thumb,
    .planner-grid::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.55);
      border-radius: 999px;
    }

    .backlog-dropzone.is-over {
      border-color: var(--accent);
      background: rgba(34, 197, 94, 0.07);
    }

    .resource-btn-row {
      margin-top: 0.35rem;
      display: flex;
      justify-content: flex-end;
    }

    /* Syllabus topic tabs inside backlog panel */
    .syllabus-topic-tabs {
      margin-top: 0.35rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }

    .syllabus-topic-tab {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 0.15rem 0.5rem;
      font-size: 0.72rem;
      background: rgba(15, 23, 42, 0.75);
      color: var(--text-muted);
      cursor: pointer;
    }

    .syllabus-topic-tab.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: #bbf7d0;
    }

    body[data-theme="light"] .syllabus-topic-tab {
      background: #e5e7eb;
      color: #4b5563;
    }

    body[data-theme="light"] .syllabus-topic-tab.active {
      color: #065f46;
    }

    /* Planner (center) */
    .planner-area {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .planner-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
    }

    .planner-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .planner-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .planner-grid {
      flex: 1;
      display: flex;
      flex-direction: column; /* weeks stacked vertically */
      gap: 0.6rem;
    }

    .week-row {
      background: var(--panel-bg);
      border-radius: 1rem;
      border: 1px solid var(--border-subtle);
      padding: 0.55rem 0.6rem 0.6rem;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.8);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    body[data-theme="light"] .week-row {
      box-shadow: 0 10px 28px rgba(15, 23, 42, 0.2);
    }

    .week-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 0.35rem;
      border-bottom: 1px dashed rgba(148, 163, 184, 0.55);
    }

    .week-name {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .week-count {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .week-slots-row {
      display: grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap: 0.5rem;
      align-items: flex-start;
    }

    .slot {
      border-radius: 0.75rem;
      background: var(--bg-alt);
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 0.35rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      min-height: 64px;
    }

    .slot-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
    }

    .slot-title {
      font-weight: 600;
    }

    .slot-chip {
      font-size: 0.65rem;
      border-radius: 999px;
      padding: 0.05rem 0.4rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-muted);
      background: rgba(15, 23, 42, 0.08);
    }

    body[data-theme="light"] .slot-chip {
      background: #e5e7eb;
    }

    .slot-dropzone {
      margin-top: 0.15rem;
      min-height: 40px;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      padding: 0.1rem;
      border-radius: 0.5rem;
      transition: background 0.15s ease, border-color 0.15s ease;
    }

    .slot-dropzone.is-over {
      background: rgba(34, 197, 94, 0.07);
      border: 1px dashed rgba(34, 197, 94, 0.7);
      padding: 0.2rem;
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      border-radius: 0.7rem;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 0.4rem 0.45rem;
      cursor: grab;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.85);
      font-size: 0.75rem;
      position: relative;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        border-color 0.12s ease;
    }

    body[data-theme="light"] .card {
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.18);
    }

    .card:hover {
      transform: translateY(-1px);
      border-color: var(--accent);
      box-shadow: 0 15px 32px rgba(15, 23, 42, 0.95);
    }

    body[data-theme="light"] .card:hover {
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.28);
    }

    .card.dragging {
      opacity: 0.7;
      border-color: var(--accent);
      box-shadow: 0 16px 34px rgba(34, 197, 94, 0.65);
      transform: scale(1.01);
    }

    .card-tag-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.68rem;
    }

    .card-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .card-tag span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    .card-tag.syllabus span.dot {
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.8);
    }

    .card-tag.textbook span.dot {
      background: var(--accent-blue);
      box-shadow: 0 0 8px rgba(56, 189, 248, 0.8);
    }

    .card-tag.resource span.dot {
      background: var(--accent-purple);
      box-shadow: 0 0 8px rgba(168, 85, 247, 0.8);
    }

    .card-main {
      font-size: 0.75rem;
      color: var(--text-main);
    }

    .card-main strong {
      font-weight: 600;
    }

    .card-sub {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .card-sub a {
      color: var(--accent-blue);
      text-decoration: none;
    }

    .card-sub a:hover {
      text-decoration: underline;
    }

    .pill {
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 0.7rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    /* Topic bubbles – per-topic colours (syllabus) */

    /* Dark theme */
    body[data-theme="dark"] .pill-syllabus.topic-number-and-algebra {
      background: rgba(34, 197, 94, 0.16);
      color: #bbf7d0;
      border-color: rgba(34, 197, 94, 0.7);
    }

    body[data-theme="dark"] .pill-syllabus.topic-functions {
      background: rgba(56, 189, 248, 0.16);
      color: #e0f2fe;
      border-color: rgba(56, 189, 248, 0.7);
    }

    body[data-theme="dark"] .pill-syllabus.topic-geometry-and-trigonometry {
      background: rgba(129, 140, 248, 0.2);
      color: #e0e7ff;
      border-color: rgba(129, 140, 248, 0.8);
    }

    body[data-theme="dark"] .pill-syllabus.topic-statistics-and-probability {
      background: rgba(251, 191, 36, 0.18);
      color: #fef3c7;
      border-color: rgba(251, 191, 36, 0.8);
    }

    body[data-theme="dark"] .pill-syllabus.topic-calculus {
      background: rgba(244, 114, 182, 0.2);
      color: #fce7f3;
      border-color: rgba(244, 114, 182, 0.85);
    }

    /* Light theme */
    body[data-theme="light"] .pill-syllabus.topic-number-and-algebra {
      background: #dcfce7;
      color: #166534;
      border-color: #16a34a;
    }

    body[data-theme="light"] .pill-syllabus.topic-functions {
      background: #e0f2fe;
      color: #075985;
      border-color: #0284c7;
    }

    body[data-theme="light"] .pill-syllabus.topic-geometry-and-trigonometry {
      background: #e0e7ff;
      color: #3730a3;
      border-color: #4f46e5;
    }

    body[data-theme="light"] .pill-syllabus.topic-statistics-and-probability {
      background: #fef3c7;
      color: #92400e;
      border-color: #f59e0b;
    }

    body[data-theme="light"] .pill-syllabus.topic-calculus {
      background: #fce7f3;
      color: #9d174d;
      border-color: #f472b6;
    }

    /* Textbook + resource pills keep their colour by type */

    body[data-theme="dark"] .pill-textbook {
      background: rgba(56, 189, 248, 0.16);
      color: #e0f2fe;
      border-color: rgba(56, 189, 248, 0.7);
    }

    body[data-theme="dark"] .pill-resource {
      background: rgba(168, 85, 247, 0.16);
      color: #ede9fe;
      border-color: rgba(168, 85, 247, 0.7);
    }

    body[data-theme="light"] .pill-textbook {
      background: #e0f2fe;
      color: #075985;
      border-color: #0284c7;
    }

    body[data-theme="light"] .pill-resource {
      background: #ede9fe;
      color: #5b21b6;
      border-color: #7c3aed;
    }

    .card-tag-label {
      opacity: 0.8;
    }

    @media (max-width: 1200px) {
      main {
        flex-direction: column;
      }
      .left-column,
      .right-column {
        position: static;
        max-height: none;
        overflow-y: visible;
        flex-direction: row;
        flex-wrap: wrap;
        width: 100%;
        max-width: none;
      }
      .panel {
        flex: 1 1 260px;
      }
    }

    @media (max-width: 900px) {
      header {
        position: static;
      }
      main {
        padding: 0.75rem;
      }
      .week-slots-row {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <!-- MathJax for LaTeX rendering in cards -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [
          ["$", "$"],
          ["\\(", "\\)"]
        ]
      },
      svg: { fontCache: "global" }
    };
  </script>
  <script
    id="MathJax-script"
    async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"
  ></script>
</head>
<body data-theme="dark">
  <header>
    <div class="header-top">
      <div>
        <h1>IB AA Term Planner – Topic 1: Number & Algebra</h1>
        <div class="badge">
          8 terms × 10 weeks • Syllabus / textbook / resources • LaTeX enabled
        </div>
      </div>
      <button id="resetLayoutBtn" title="Reset all placements">
        ⟳ Reset layout
      </button>
    </div>
    <div class="term-tabs" id="termTabs"></div>
    <div class="header-controls">
      <div>
        Each term has 10 weeks. Select a term, then drag cards into syllabus / textbook /
        resource lanes. Use LaTeX like <code>$a\times 10^k$</code> in syllabus text.
      </div>
      <div class="header-actions">
        <span id="summaryLabel"></span>
        <button id="themeToggleBtn" title="Toggle light/dark mode">
          ☀ Light mode
        </button>
        <button id="exportBtn" title="Export planner as JSON">
          ⭳ Export JSON
        </button>
        <button id="importBtn" title="Import planner from JSON">
          ⭱ Import JSON
        </button>
        <input
          type="file"
          id="importFileInput"
          accept="application/json"
          style="display: none"
        />
      </div>
    </div>
  </header>

  <main>
    <!-- LEFT: syllabus + resources -->
    <aside class="left-column">
      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Syllabus backlog</div>
            <div class="panel-subtitle">
              Topic-filtered backlog (unassigned cards only)
            </div>
          </div>
          <span id="syllabusBacklogCount" class="panel-subtitle"></span>
        </div>
        <div id="syllabusTopicTabs" class="syllabus-topic-tabs"></div>
        <div
          class="backlog-dropzone"
          id="syllabusBacklog"
          data-location-type="backlog"
          data-accept-type="syllabus"
        ></div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Resources / information</div>
            <div class="panel-subtitle">
              Create extra notes (links, PDFs, activities) and drag into weeks
            </div>
          </div>
          <span id="resourceBacklogCount" class="panel-subtitle"></span>
        </div>
        <div
          class="backlog-dropzone"
          id="resourceBacklog"
          data-location-type="backlog"
          data-accept-type="resource"
        ></div>
        <div class="resource-btn-row">
          <button id="newResourceBtn" class="primary">
            ＋ New resource note
          </button>
        </div>
      </section>
    </aside>

    <!-- CENTER: planner -->
    <section class="planner-area">
      <div class="planner-header-row">
        <div>
          <div class="planner-title">
            Weekly layout – <span id="currentTermLabel"></span>
          </div>
          <div class="planner-subtitle">
            Weeks run down the page. Within each week, left-to-right:
            syllabus objectives, textbook references, and additional resources.
          </div>
        </div>
      </div>
      <div class="planner-grid" id="plannerGrid"></div>
    </section>

    <!-- RIGHT: textbook references -->
    <aside class="right-column">
      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Textbook references</div>
            <div class="panel-subtitle">
              Drag into the textbook lane for each week
            </div>
          </div>
          <span id="textbookBacklogCount" class="panel-subtitle"></span>
        </div>
        <div
          class="backlog-dropzone"
          id="textbookBacklog"
          data-location-type="backlog"
          data-accept-type="textbook"
        ></div>
      </section>
    </aside>
  </main>

  <script>
    /**********************************************************
     * SYLLABUS OBJECTIVES – AHL Topics 1–5, with topic tags
     **********************************************************/
    const SYLLABUS_OBJECTIVES = [
  /**********************************************************
   * TOPIC 1 — NUMBER & ALGEBRA (SL)
   **********************************************************/
  {
    id: "AA_SL1-1",
    section: "SL 1.1",
    topic: "Number and Algebra",
    text: `Use and interpret numbers written in scientific notation of the form $a \\times 10^k$ with $1 \\le a < 10$ and integer $k$, and apply this in real contexts (very large and very small quantities).`
  },
  {
    id: "AA_SL1-2",
    section: "SL 1.2",
    topic: "Number and Algebra",
    text: `Work with arithmetic sequences: generate terms, recognise patterns, and use the formulas $u_n = a + (n-1)d$ and $S_n = \\dfrac{n}{2}\\bigl(2a + (n-1)d\\bigr)$ for the $n$th term and partial sums.`
  },
  {
    id: "AA_SL1-3",
    section: "SL 1.3",
    topic: "Number and Algebra",
    text: `Work with geometric sequences: generate terms, recognise common ratios, and use the formulas $u_n = ar^{n-1}$ and $S_n = a \\dfrac{1 - r^n}{1 - r}$ (for $r \\neq 1$) for the $n$th term and partial sums.`
  },
  {
    id: "AA_SL1-4",
    section: "SL 1.4",
    topic: "Number and Algebra",
    text: `Apply geometric sequences to basic financial situations, including compound interest, depreciation, loans and annuities; interpret and use the future value and present value formulas in contexts such as savings, investments and repayments.`
  },
  {
    id: "AA_SL1-5",
    section: "SL 1.5",
    topic: "Number and Algebra",
    text: `Use the index laws for integer exponents, such as $a^m a^n = a^{m+n}$, $(a^m)^n = a^{mn}$, $a^0 = 1$, and $a^{-n} = \\dfrac{1}{a^n}$ for $a \\neq 0$, and simplify expressions using these rules.`
  },
  {
    id: "AA_SL1-6",
    section: "SL 1.6",
    topic: "Number and Algebra",
    text: `Introduce logarithms as the inverse of exponentials; interpret $\\log_a x$ as the power to which $a$ must be raised to obtain $x$, and use basic laws such as $\\log_a(xy)$, $\\log_a\\left(\\dfrac{x}{y}\\right)$ and $\\log_a(x^k)$.`
  },
  {
    id: "AA_SL1-7",
    section: "SL 1.7",
    topic: "Number and Algebra",
    text: `Extend exponent laws to rational indices, for example $a^{1/n} = \\sqrt[n]{a}$ for $a > 0$ and $n \\in \\mathbb{N}$, and $a^{p/q} = \\sqrt[q]{a^p}$; use these to simplify expressions involving radicals and fractional powers.`
  },
  {
    id: "AA_SL1-8",
    section: "SL 1.8",
    topic: "Number and Algebra",
    text: `Recognise when an infinite geometric series with first term $a$ and common ratio $r$ has a finite sum (when $|r| < 1$), and use $S_\\infty = \\dfrac{a}{1 - r}$ in appropriate contexts (for example, repeated percentage reductions).`
  },
  {
    id: "AA_SL1-9",
    section: "SL 1.9",
    topic: "Number and Algebra",
    text: `Use the binomial expansion $(a + b)^n = \\displaystyle\\sum_{k=0}^{n} \\binom{n}{k} a^{n-k} b^k$ for positive integer $n$; compute and interpret binomial coefficients $\\binom{n}{k}$ and apply the expansion in algebraic and modelling contexts.`
  },

  /**********************************************************
   * TOPIC 2 — FUNCTIONS (SL)
   **********************************************************/
  {
    id: "AA_SL2-1",
    section: "SL 2.1",
    topic: "Functions",
    text: `Understand the concept of a function $f: X \\to Y$, including domain, range (image), and notation such as $f(x)$; evaluate functions given in algebraic, tabular or graphical form.`
  },
  {
    id: "AA_SL2-2",
    section: "SL 2.2",
    topic: "Functions",
    text: `Describe and interpret key features of graphs of functions: intercepts, intervals of increase and decrease, local maxima and minima, end behaviour and symmetry (even, odd, or neither).`
  },
  {
    id: "AA_SL2-3",
    section: "SL 2.3",
    topic: "Functions",
    text: `Form and work with composite functions $(f \\circ g)(x) = f(g(x))$, determine appropriate domains, and use composition in applied contexts where one quantity depends on another through multiple stages.`
  },
  {
    id: "AA_SL2-4",
    section: "SL 2.4",
    topic: "Functions",
    text: `Understand inverse functions $f^{-1}$ where $f$ is one-to-one on a suitable restricted domain; use the relationships $f(f^{-1}(x)) = x$ and $f^{-1}(f(x)) = x$; sketch $f^{-1}$ as the reflection of $f$ in the line $y = x$.`
  },
  {
    id: "AA_SL2-5",
    section: "SL 2.5",
    topic: "Functions",
    text: `Analyse quadratic functions $f(x) = ax^2 + bx + c$; complete the square to find the vertex, axis of symmetry and maximum or minimum; determine intercepts and solve quadratic equations.`
  },
  {
    id: "AA_SL2-6",
    section: "SL 2.6",
    topic: "Functions",
    text: `Analyse polynomial functions and their graphs: identify degree, leading coefficient and end behaviour; use factorisation and the factor/remainder theorem to find roots and interpret their multiplicity.`
  },
  {
    id: "AA_SL2-7",
    section: "SL 2.7",
    topic: "Functions",
    text: `Analyse simple rational functions of the form $f(x) = \\dfrac{ax + b}{cx + d}$ or $f(x) = \\dfrac{ax^2 + bx + c}{dx + e}$, including vertical and horizontal (or oblique) asymptotes and behaviour near discontinuities.`
  },
  {
    id: "AA_SL2-8",
    section: "SL 2.8",
    topic: "Functions",
    text: `Work with exponential functions $f(x) = a b^x$ and logarithmic functions $f(x) = \\log_a x$; sketch graphs, identify domain and range, and apply these functions in modelling contexts such as growth and decay.`
  },
  {
    id: "AA_SL2-9",
    section: "SL 2.9",
    topic: "Functions",
    text: `Apply graph transformations to functions: vertical and horizontal translations, reflections in the axes, and stretches/compressions; interpret transformations of the form $y = f(x) + k$, $y = f(x-k)$, $y = af(x)$, $y = f(ax)$.`
  },
  {
    id: "AA_SL2-10",
    section: "SL 2.10",
    topic: "Functions",
    text: `Solve equations and inequalities graphically by finding intersections of graphs (for example $f(x) = g(x)$ or $f(x) \\ge g(x)$); use technology where algebraic methods are difficult or impossible.`
  },
  {
    id: "AA_SL2-11",
    section: "SL 2.11",
    topic: "Functions",
    text: `Interpret asymptotic and limiting behaviour from graphs of functions (for example, $f(x) \\to L$ as $x \\to \\infty$ or $x \\to a$); recognise piecewise-defined and absolute value functions and sketch their graphs.`
  },

  /**********************************************************
   * TOPIC 3 — GEOMETRY & TRIGONOMETRY (SL)
   **********************************************************/
  {
    id: "AA_SL3-1",
    section: "SL 3.1",
    topic: "Geometry and Trigonometry",
    text: `Use coordinates in two dimensions: calculate the distance between two points, the midpoint of a segment, and interpret coordinates in geometrical and contextual problems.`
  },
  {
    id: "AA_SL3-2",
    section: "SL 3.2",
    topic: "Geometry and Trigonometry",
    text: `Determine gradients (slopes) of lines; find equations of lines given a point and gradient, two points, or parallel/perpendicular conditions; work with forms such as $y - y_1 = m(x - x_1)$ and $ax + by + c = 0$.`
  },
  {
    id: "AA_SL3-3",
    section: "SL 3.3",
    topic: "Geometry and Trigonometry",
    text: `Calculate the angle between two lines using gradients, and find the distance from a point to a line; apply these results in geometric and modelling contexts.`
  },
  {
    id: "AA_SL3-4",
    section: "SL 3.4",
    topic: "Geometry and Trigonometry",
    text: `Use Pythagoras’ theorem and the trigonometric ratios $\\sin\\theta$, $\\cos\\theta$ and $\\tan\\theta$ in right-angled triangles; recall exact values for standard angles such as $0^\\circ, 30^\\circ, 45^\\circ, 60^\\circ, 90^\\circ$.`
  },
  {
    id: "AA_SL3-5",
    section: "SL 3.5",
    topic: "Geometry and Trigonometry",
    text: `Work with radian measure; convert between degrees and radians; use $s = r\\theta$ and $A = \\tfrac{1}{2} r^2 \\theta$ for arc length and sector area when $\\theta$ is in radians.`
  },
  {
    id: "AA_SL3-6",
    section: "SL 3.6",
    topic: "Geometry and Trigonometry",
    text: `Sketch and interpret graphs of $y = \\sin x$, $y = \\cos x$, and $y = \\tan x$ (in degrees or radians) over specified domains; identify amplitude, period, and key features such as zeros and asymptotes.`
  },
  {
    id: "AA_SL3-7",
    section: "SL 3.7",
    topic: "Geometry and Trigonometry",
    text: `Solve basic trigonometric equations in one variable, such as $\\sin x = k$, $\\cos x = k$, $\\tan x = k$, in a finite interval; find all solutions in the given domain and interpret them in context.`
  },
  {
    id: "AA_SL3-8",
    section: "SL 3.8",
    topic: "Geometry and Trigonometry",
    text: `Use the sine rule and cosine rule in non-right-angled triangles, including ambiguous cases (obtuse angle situations), and calculate areas of triangles using $A = \\tfrac{1}{2} ab \\sin C$.`
  },

  /**********************************************************
   * TOPIC 4 — STATISTICS & PROBABILITY (SL)
   **********************************************************/
  {
    id: "AA_SL4-1",
    section: "SL 4.1",
    topic: "Statistics and Probability",
    text: `Describe and summarise single-variable data: construct and interpret tables, histograms, stem-and-leaf diagrams and box-and-whisker plots; calculate mean, median, mode, range, interquartile range and standard deviation.`
  },
  {
    id: "AA_SL4-2",
    section: "SL 4.2",
    topic: "Statistics and Probability",
    text: `Analyse bivariate data: draw and interpret scatter diagrams, describe correlation (positive, negative, zero), and use technology to find and interpret a least-squares regression line.`
  },
  {
    id: "AA_SL4-3",
    section: "SL 4.3",
    topic: "Statistics and Probability",
    text: `Understand basic probability concepts: sample space, events and outcomes; use Venn diagrams, two-way tables and tree diagrams to represent and compute probabilities.`
  },
  {
    id: "AA_SL4-4",
    section: "SL 4.4",
    topic: "Statistics and Probability",
    text: `Use the addition rule $P(A \\cup B) = P(A) + P(B) - P(A \\cap B)$, the multiplication rule $P(A \\cap B) = P(A)P(B \\mid A)$, and recognise mutually exclusive and independent events.`
  },
  {
    id: "AA_SL4-5",
    section: "SL 4.5",
    topic: "Statistics and Probability",
    text: `Work with discrete random variables: probability distributions, expected value $E(X)$, variance $\\operatorname{Var}(X)$ and standard deviation; use simple real-world contexts (for example games of chance).`
  },
  {
    id: "AA_SL4-6",
    section: "SL 4.6",
    topic: "Statistics and Probability",
    text: `Use the binomial distribution $X \\sim \\operatorname{Bin}(n,p)$ to model the number of successes in repeated Bernoulli trials; compute probabilities using the binomial formula and technology.`
  },
  {
    id: "AA_SL4-7",
    section: "SL 4.7",
    topic: "Statistics and Probability",
    text: `Use the normal distribution $X \\sim N(\\mu, \\sigma^2)$; standardise using $z = \\dfrac{x - \\mu}{\\sigma}$; find probabilities and quantiles (inverse normal) using technology; interpret the $68$–$95$–$99.7\\%$ rule.`
  },

  /**********************************************************
   * TOPIC 5 — CALCULUS (SL)
   **********************************************************/
  {
    id: "AA_SL5-1",
    section: "SL 5.1",
    topic: "Calculus",
    text: `Introduce the derivative as the limit of the average rate of change: $f'(x) = \\displaystyle\\lim_{h \\to 0} \\dfrac{f(x+h) - f(x)}{h}$; interpret it as the gradient of the tangent and as an instantaneous rate of change.`
  },
  {
    id: "AA_SL5-2",
    section: "SL 5.2",
    topic: "Calculus",
    text: `Differentiate basic functions using standard rules: power rule for $x^n$, constant multiples and sums; apply the product rule, quotient rule and chain rule in simple combinations.`
  },
  {
    id: "AA_SL5-3",
    section: "SL 5.3",
    topic: "Calculus",
    text: `Differentiate exponential functions $e^x$ and $a^x$, logarithmic functions $\\ln x$ and $\\log_a x$, and the trigonometric functions $\\sin x$, $\\cos x$ and $\\tan x$ over appropriate domains.`
  },
  {
    id: "AA_SL5-4",
    section: "SL 5.4",
    topic: "Calculus",
    text: `Use the derivative to find tangents and normals to curves, identify local maxima and minima, and determine intervals where a function is increasing or decreasing.`
  },
  {
    id: "AA_SL5-5",
    section: "SL 5.5",
    topic: "Calculus",
    text: `Solve optimisation problems in one variable (for example, maximising area or minimising cost) by modelling the situation, differentiating and applying conditions for maxima or minima.`
  },
  {
    id: "AA_SL5-6",
    section: "SL 5.6",
    topic: "Calculus",
    text: `Understand indefinite integrals as anti-derivatives: if $F'(x) = f(x)$ then $\\int f(x)\\,dx = F(x) + C$. Use basic integration rules for powers, exponentials, and simple trigonometric and logarithmic functions.`
  },
  {
    id: "AA_SL5-7",
    section: "SL 5.7",
    topic: "Calculus",
    text: `Interpret a definite integral as the signed area under a curve: $\\displaystyle\\int_a^b f(x)\\,dx$, and apply the Fundamental Theorem of Calculus to evaluate definite integrals.`
  },
  {
    id: "AA_SL5-8",
    section: "SL 5.8",
    topic: "Calculus",
    text: `Find areas between a curve and the coordinate axes and areas between two curves by evaluating appropriate definite integrals.`
  },
  {
    id: "AA_SL5-9",
    section: "SL 5.9",
    topic: "Calculus",
    text: `Model motion in one dimension: relate displacement $s(t)$, velocity $v(t)$ and acceleration $a(t)$ using $v = \\dfrac{ds}{dt}$ and $a = \\dfrac{dv}{dt}$; use integration to recover velocity and displacement from acceleration.`
  },

  /**********************************************************
   * TOPIC 1 — NUMBER & ALGEBRA (AHL)
   **********************************************************/
{
  id: "AA_SL1-1",
  section: "SL 1.1",
  topic: "Number and Algebra",
  text: "Operations with numbers in the form $a \\times 10^k$ where $1 \\le a < 10$ and $k$ is an integer."
}
,

{
  id: "AA_SL1-2",
  section: "SL 1.2",
  topic: "Number and Algebra",
  text: "Arithmetic sequences and series. Use of the formulae for the $n$th term and the sum of the first $n$ terms of the sequence; use of sigma notation."
}
,

{
  id: "AA_SL1-3",
  section: "SL 1.3",
  topic: "Number and Algebra",
  text: "Geometric sequences and series. Use of the formulae for the $n$th term and the sum of the first $n$ terms; use of sigma notation for sums of geometric sequences."
}
,

{
  id: "AA_SL1-4",
  section: "SL 1.4",
  topic: "Number and Algebra",
  text: "Financial applications of geometric sequences and series: compound interest and annual depreciation; calculation of real value of an investment with inflation."
}
,

{
  id: "AA_SL1-5",
  section: "SL 1.5",
  topic: "Number and Algebra",
  text: "Laws of exponents with integer exponents; introduction to logarithms with base 10 and $e$; awareness that $a^x = b$ is equivalent to $\\log_a b = x$ and that $\\log_e x = \\ln x$."
}
,

{
  id: "AA_SL1-6",
  section: "SL 1.6",
  topic: "Number and Algebra",
  text: "Simple deductive proof, numerical and algebraic; layout of LHS to RHS proofs; recognition of equality and identity notation."
}
,

{
  id: "AA_SL1-8",
  section: "SL 1.8",
  topic: "Number and Algebra",
  text: "Sum of infinite convergent geometric sequences. Use of $|r|<1$ and modulus notation."
}
,

{
  id: "AA_SL1-9",
  section: "SL 1.9",
  topic: "Number and Algebra",
  text: "The binomial theorem: expansion of $(a+b)^n$, $n\\in \\mathbb{N}$; use of Pascal’s triangle and ${n \\choose r}$."
}
AHL Objectives
,

{
  id: "AA_AHL1-10",
  section: "AHL 1.10",
  topic: "Number and Algebra",
  text: "Counting principles including permutations and combinations; extension of the binomial theorem to fractional and negative indices: $(a+b)^n$, $n\\in \\mathbb{Q}$."
}
,

{
  id: "AA_AHL1-11",
  section: "AHL 1.11",
  topic: "Number and Algebra",
  text: "Partial fractions: maximum of two distinct linear terms in the denominator, with degree of numerator less than the degree of the denominator."
}
,

{
  id: "AA_AHL1-12",
  section: "AHL 1.12",
  topic: "Number and Algebra",
  text: "Complex numbers: $i$ where $i^2=-1$; Cartesian form $z=a+bi$; real/imaginary parts, conjugate, modulus and argument; the complex plane."
}
,

{
  id: "AA_AHL1-13",
  section: "AHL 1.13",
  topic: "Number and Algebra",
  text: "Modulus–argument (polar) form: $z = r(\\cos\\theta + i\\sin\\theta)=r\\,\\mathrm{cis}\\,\\theta$; Euler form $z = re^{i\\theta}$; sums, products and quotients in Cartesian, polar or Euler forms, and their geometric interpretations."
}
,

{
  id: "AA_AHL1-14",
  section: "AHL 1.14",
  topic: "Number and Algebra",
  text: "Complex roots of polynomial equations; the fundamental theorem of algebra; De Moivre’s theorem."
}

  /**********************************************************
   * TOPIC 2 — FUNCTIONS (AHL)
   **********************************************************/
  {
    id: "AA_AHL2-12",
    section: "AHL 2.12",
    topic: "Functions",
    text: `Analyse higher-degree polynomial functions; use the factor and remainder theorems; express a polynomial $f(x)$ as $(x - a)q(x) + r$ and apply this to find factors and roots; relate coefficients to sums and products of roots.`
  },
  {
    id: "AA_AHL2-13",
    section: "AHL 2.13",
    topic: "Functions",
    text: `Study more general rational functions: identify all asymptotes (vertical, horizontal, oblique), intercepts and local behaviour; interpret how numerator and denominator degrees influence end behaviour.`
  },
  {
    id: "AA_AHL2-14",
    section: "AHL 2.14",
    topic: "Functions",
    text: `Work with even and odd functions and recognise their symmetry; identify self-inverse functions (involutions) and verify the condition $f(f(x)) = x$ on a given domain.`
  },
  {
    id: "AA_AHL2-15",
    section: "AHL 2.15",
    topic: "Functions",
    text: `Extend work with inverse functions, including for functions that are not globally one-to-one by restricting domains; solve equations using inverse functions and interpret the effect of inverses on graphs.`
  },
  {
    id: "AA_AHL2-16",
    section: "AHL 2.16",
    topic: "Functions",
    text: `Solve inequalities of the form $g(x) \\ge f(x)$ or $g(x) > f(x)$ for functions including polynomials, rationals, exponentials and logs, both algebraically (where possible) and graphically with technology.`
  },

  /**********************************************************
   * TOPIC 3 — GEOMETRY & TRIGONOMETRY (AHL)
   **********************************************************/
  {
    id: "AA_AHL3-9",
    section: "AHL 3.9",
    topic: "Geometry and Trigonometry",
    text: `Explore fractals and self-similar structures (for example, the Koch snowflake, Sierpiński triangle); describe their recursive construction and basic geometric properties.`
  },
  {
    id: "AA_AHL3-10",
    section: "AHL 3.10",
    topic: "Geometry and Trigonometry",
    text: `Use compound-angle identities such as $\\sin(\\alpha \\pm \\beta)$ and $\\cos(\\alpha \\pm \\beta)$, and deduce double-angle formulas including $\\sin 2\\theta$, $\\cos 2\\theta$ and $\\tan 2\\theta$; apply these to solve trigonometric equations and simplify expressions.`
  },
  {
    id: "AA_AHL3-11",
    section: "AHL 3.11",
    topic: "Geometry and Trigonometry",
    text: `Apply the sine and cosine rules to more advanced triangle problems, including non-right-angled triangles in $2$D and $3$D; handle ambiguous cases and interpret results in context.`
  },
  {
    id: "AA_AHL3-12",
    section: "AHL 3.12",
    topic: "Geometry and Trigonometry",
    text: `Solve trigonometric equations of the form $a\\sin(kx) + b\\cos(kx) = c$ over specified intervals in degrees or radians; use identities and methods such as expressing $a\\sin x + b\\cos x$ as $R\\sin(x + \\phi)$.`
  },
  {
    id: "AA_AHL3-13",
    section: "AHL 3.13",
    topic: "Geometry and Trigonometry",
    text: `Work with vectors in $\\mathbb{R}^2$ and $\\mathbb{R}^3$: define the scalar (dot) product, compute $\\mathbf{a} \\cdot \\mathbf{b} = |\\mathbf{a}||\\mathbf{b}|\\cos\\theta$ and use it to find the angle between two vectors and projections.`
  },
  {
    id: "AA_AHL3-14",
    section: "AHL 3.14",
    topic: "Geometry and Trigonometry",
    text: `Use vector equations of lines in $\\mathbb{R}^2$ and $\\mathbb{R}^3$, of the form $\\mathbf{r} = \\mathbf{a} + \\lambda \\mathbf{b}$; interpret $\\mathbf{a}$ as a point on the line and $\\mathbf{b}$ as a direction vector; convert between vector, parametric and Cartesian forms.`
  },
  {
    id: "AA_AHL3-15",
    section: "AHL 3.15",
    topic: "Geometry and Trigonometry",
    text: `Find the angle between two lines, and between a line and a plane; compute the distance from a point to a line or plane using vector methods.`
  },
  {
    id: "AA_AHL3-16",
    section: "AHL 3.16",
    topic: "Geometry and Trigonometry",
    text: `Use vectors to solve geometric problems involving intersections of lines and planes, conditions for parallelism and perpendicularity, and simple locus problems in three dimensions.`
  },
  {
    id: "AA_AHL3-17",
    section: "AHL 3.17",
    topic: "Geometry and Trigonometry",
    text: `Compute areas of triangles and parallelograms using vector cross products: area of a triangle $= \\tfrac{1}{2} |\\mathbf{a} \\times \\mathbf{b}|$, area of a parallelogram $= |\\mathbf{a} \\times \\mathbf{b}|$.`
  },
  {
    id: "AA_AHL3-18",
    section: "AHL 3.18",
    topic: "Geometry and Trigonometry",
    text: `Compute volumes of parallelepipeds and related solids using the scalar triple product $\\mathbf{a} \\cdot (\\mathbf{b} \\times \\mathbf{c})$, and interpret this quantity geometrically.`
  },

  /**********************************************************
   * TOPIC 4 — STATISTICS & PROBABILITY (AHL)
   **********************************************************/
  {
    id: "AA_AHL4-13",
    section: "AHL 4.13",
    topic: "Statistics and Probability",
    text: `Apply Bayes’ theorem to update probabilities: use $P(A \\mid B) = \\dfrac{P(A \\cap B)}{P(B)}$ and tree or table representations to solve problems involving conditional probability and revision of beliefs.`
  },
  {
    id: "AA_AHL4-14",
    section: "AHL 4.14",
    topic: "Statistics and Probability",
    text: `Work with continuous probability distributions: interpret and use probability density functions $f(x)$, compute probabilities as $P(a \\le X \\le b) = \\int_a^b f(x)\\,dx$, and find mean, variance and simple measures such as median and mode from the pdf.`
  },

  /**********************************************************
   * TOPIC 5 — CALCULUS (AHL)
   **********************************************************/
  {
    id: "AA_AHL5-10",
    section: "AHL 5.10",
    topic: "Calculus",
    text: `Use the second derivative $f''(x)$ to determine concavity (concave up / concave down) and points of inflexion, and apply the second derivative test to classify local maxima and minima.`
  },
  {
    id: "AA_AHL5-11",
    section: "AHL 5.11",
    topic: "Calculus",
    text: `Evaluate more challenging integrals, including those requiring substitution and integration by parts; integrate functions such as $x^n e^{ax}$, $e^{ax} \\sin bx$, and simple rational functions.`
  },
  {
    id: "AA_AHL5-12",
    section: "AHL 5.12",
    topic: "Calculus",
    text: `Compute areas of regions bounded by curves and coordinate axes, and volumes of solids of revolution about the $x$- or $y$-axis using formulas such as $V = \\pi \\int_a^b y^2\\,dx$ and $V = \\pi \\int_a^b x^2\\,dy$.`
  },
  {
    id: "AA_AHL5-13",
    section: "AHL 5.13",
    topic: "Calculus",
    text: `Model motion using parametric or vector functions: relate position, velocity and acceleration; interpret graphs of $s(t)$, $v(t)$ and $a(t)$ and solve more advanced kinematics problems with calculus.`
  },
  {
    id: "AA_AHL5-14",
    section: "AHL 5.14",
    topic: "Calculus",
    text: `Set up and solve first-order differential equations arising from growth and decay and other applications, typically of the form $\\dfrac{dy}{dx} = ky$ or $\\dfrac{dy}{dx} = ky(1-y)$, by separation of variables.`
  },
  {
    id: "AA_AHL5-15",
    section: "AHL 5.15",
    topic: "Calculus",
    text: `Interpret slope fields (direction fields) for differential equations of the form $\\dfrac{dy}{dx} = f(x,y)$, and sketch qualitative solution curves based on the slope field.`
  },
  {
    id: "AA_AHL5-16",
    section: "AHL 5.16",
    topic: "Calculus",
    text: `Use Euler’s method (and related step-by-step numerical schemes) to approximate solutions to first-order differential equations; apply formulas such as $x_{n+1} = x_n + h$ and $y_{n+1} = y_n + h f(x_n,y_n)$.`
  },
  {
    id: "AA_AHL5-17",
    section: "AHL 5.17",
    topic: "Calculus",
    text: `Analyse simple coupled first-order linear systems, such as $\\dfrac{dx}{dt} = ax + by$, $\\dfrac{dy}{dt} = cx + dy$; use eigenvalues to classify equilibrium points and describe qualitative behaviour in a phase plane.`
  },
  {
    id: "AA_AHL5-18",
    section: "AHL 5.18",
    topic: "Calculus",
    text: `Solve first-order differential equations of the form $\\dfrac{dy}{dx} = f\\!\\left(\\dfrac{y}{x}\\right)$ by using the substitution $y = vx$; solve linear first-order equations $y' + P(x)y = Q(x)$ using integrating factors.`
  },
  {
    id: "AA_AHL5-19",
    section: "AHL 5.19",
    topic: "Calculus",
    text: `Use Maclaurin series to expand standard functions such as $e^x$, $\\sin x$, $\\cos x$, $\\ln(1 + x)$ and $(1 + x)^p$ for rational $p$; generate new series by substitution, differentiation and integration, and apply series to approximation problems.`
  }
];


    // Sample textbook references – add your actual exercise URLs in `url` fields
    const TEXTBOOK_REFERENCES = [
     {
    id: "tb-0",
    label: "Haese IB AA SL – Ch 1: The Binomial Theorem",
    detail: "Factorial notation, binomial expansions, the binomial theorem, related problem solving.",
    url: ""
  },
  {
    id: "tb-1",
    label: "Haese IB AA SL – Ch 2: Quadratic Functions",
    detail: "Quadratic functions, graphs, discriminant, finding equations, intersections, optimisation and inequalities.",
    url: ""
  },
  {
    id: "tb-2",
    label: "Haese IB AA SL – Ch 3: Functions",
    detail: "Relations, functions, notation, domain and range, rational and composite functions, inverse and absolute value functions.",
    url: ""
  },
  {
    id: "tb-3",
    label: "Haese IB AA SL – Ch 4: Transformations of Functions",
    detail: "Translations, stretches, reflections, and miscellaneous transformations.",
    url: ""
  },
  {
    id: "tb-4",
    label: "Haese IB AA SL – Ch 5: Exponential Functions",
    detail: "Exponents, algebraic manipulation, exponential equations, growth and decay, natural exponential function.",
    url: ""
  },
  {
    id: "tb-5",
    label: "Haese IB AA SL – Ch 6: Logarithms",
    detail: "Logarithms (base 10 and base e), laws of logarithms, natural logarithms, change of base rule, solving exponential equations.",
    url: ""
  },
  {
    id: "tb-6",
    label: "Haese IB AA SL – Ch 7: The Unit Circle and Radian Measure",
    detail: "Radian measure, arc length and area, unit circle, multiples of π/6 and π/4, Pythagorean identity, finding angles.",
    url: ""
  },
  {
    id: "tb-7",
    label: "Haese IB AA SL – Ch 8: Trigonometric Functions",
    detail: "Periodic behaviour, sine and cosine functions, general sinusoidal functions, modelling, tangent function.",
    url: ""
  },
  {
    id: "tb-8",
    label: "Haese IB AA SL – Ch 9: Trigonometric Equations and Identities",
    detail: "Trigonometric equations, modelling, identities, double-angle identities.",
    url: ""
  },
  {
    id: "tb-9",
    label: "Haese IB AA SL – Ch 10: Reasoning and Proof",
    detail: "Logical connectives, proof by deduction, proof by equivalence, definitions.",
    url: ""
  },
  {
    id: "tb-10",
    label: "Haese IB AA SL – Ch 11: Introduction to Differential Calculus",
    detail: "Rates of change, instantaneous rates, limits, gradient of a tangent, derivative from first principles.",
    url: ""
  },
  {
    id: "tb-11",
    label: "Haese IB AA SL – Ch 12: Rules of Differentiation",
    detail: "Basic derivative rules, chain rule, product rule, quotient rule, derivatives of exponential, logarithmic, and trigonometric functions.",
    url: ""
  },
  {
    id: "tb-12",
    label: "Haese IB AA SL – Ch 13: Properties of Curves",
    detail: "Tangents, normals, increasing/decreasing functions, stationary points, shape of graphs, inflection points.",
    url: ""
  },
  {
    id: "tb-13",
    label: "Haese IB AA SL – Ch 14: Applications of Differentiation",
    detail: "Optimisation, rates of change, curve sketching applications.",
    url: ""
  },
  {
    id: "tb-14",
    label: "Haese IB AA SL – Ch 15: Introduction to Integration",
    detail: "Area under curves, Riemann sums, anti-differentiation, Fundamental Theorem of Calculus.",
    url: ""
  },
  {
    id: "tb-15",
    label: "Haese IB AA SL – Ch 16: Techniques for Integration",
    detail: "Basic integration rules, particular values, integration of f(ax + b), substitution.",
    url: ""
  },
  {
    id: "tb-16",
    label: "Haese IB AA SL – Ch 17: Definite Integrals",
    detail: "Definite integrals, area under and between curves, problem solving with integration.",
    url: ""
  },
  {
    id: "tb-17",
    label: "Haese IB AA SL – Ch 18: Kinematics",
    detail: "Displacement, velocity, acceleration, speed, calculus applications in motion.",
    url: ""
  },
  {
    id: "tb-18",
    label: "Haese IB AA SL – Ch 19: Bivariate Statistics",
    detail: "Scatterplots, Pearson correlation, regression lines, least squares, interpreting correlation.",
    url: ""
  },
  {
    id: "tb-19",
    label: "Haese IB AA SL – Ch 20: Discrete Random Variables",
    detail: "Probability distributions, expectation, binomial distribution, calculations and technology use.",
    url: ""
  },
  {
    id: "tb-20",
    label: "Haese IB AA SL – Ch 21: The Normal Distribution",
    detail: "Normal distribution, calculating probabilities, z-scores, quantiles.",
    url: ""
  },

  /* ------------------------------- CORE SL ------------------------------- */

  {
    id: "tb-21",
    label: "Haese Core SL – Ch 1: Straight Lines",
    detail: "Equation of a line, graphing, perpendicular bisectors, simultaneous equations.",
    url: ""
  },
  {
    id: "tb-22",
    label: "Haese Core SL – Ch 2: Sets and Venn Diagrams",
    detail: "Sets, unions, intersections, complements, special sets, Venn diagram regions, set problems.",
    url: ""
  },
  {
    id: "tb-23",
    label: "Haese Core SL – Ch 3: Surds and Exponents",
    detail: "Surds, rationalisation, exponent laws, scientific notation.",
    url: ""
  },
  {
    id: "tb-24",
    label: "Haese Core SL – Ch 4: Equations",
    detail: "Equations of the form x² = k, power equations, factored form, quadratic equations, solving with technology.",
    url: ""
  },
  {
    id: "tb-25",
    label: "Haese Core SL – Ch 5: Sequences and Series",
    detail: "Number sequences, arithmetic and geometric sequences, growth and decay, financial mathematics, finite and infinite series.",
    url: ""
  },
  {
    id: "tb-26",
    label: "Haese Core SL – Ch 6: Measurement",
    detail: "Circles, arcs, sectors, surface area, volume, capacity.",
    url: ""
  },
  {
    id: "tb-27",
    label: "Haese Core SL – Ch 7: Right-Angled Triangle Trigonometry",
    detail: "Trig ratios, finding side lengths, angles, solving real problems, true bearings, angle between line and plane.",
    url: ""
  },
  {
    id: "tb-28",
    label: "Haese Core SL – Ch 8: Non-Right-Angled Triangle Trigonometry",
    detail: "Unit circle review, area formula, cosine rule, sine rule, ambiguous case.",
    url: ""
  },
  {
    id: "tb-29",
    label: "Haese Core SL – Ch 9: Points in Space",
    detail: "3D coordinate geometry, measurement, trigonometry in 3D.",
    url: ""
  },
  {
    id: "tb-30",
    label: "Haese Core SL – Ch 10: Probability",
    detail: "Experimental probability, two-way tables, sample spaces, theoretical probability, independence, conditional probability.",
    url: ""
  },
  {
    id: "tb-31",
    label: "Haese Core SL – Ch 11: Sampling and Data",
    detail: "Sampling errors, methods, data types, discrete and continuous data.",
    url: ""
  },
  {
    id: "tb-32",
    label: "Haese Core SL – Ch 12: Statistics",
    detail: "Measures of centre, frequency tables, grouped data, spread of data, box plots, cumulative frequency, variance and standard deviation.",
    url: ""
  }
    ];

    /**********************************************************
     * STATE + THEME
     **********************************************************/
    const TERMS = 8;
    const WEEKS_PER_TERM = 10;
    const STORAGE_KEY = "aa-term-planner-topic1-v4";
    const THEME_KEY = "aa-planner-theme";

    const state = {
      currentTerm: 1,
      layout: {},
      backlog: {
        syllabus: [],
        textbook: [],
        resource: []
      },
      resources: {},
      nextResourceId: 0,
      syllabusTopicFilter: null
    };

    /**********************************************************
     * INIT
     **********************************************************/
    document.addEventListener("DOMContentLoaded", () => {
      initTheme();
      initState();
      ensureLayoutShape();
      buildTermTabs();
      buildSyllabusTopicTabs();
      buildPlanner();
      buildBacklogs();
      renderAll();
      wireControls();
    });

    function initTheme() {
      const saved = localStorage.getItem(THEME_KEY) || "dark";
      setTheme(saved);
    }

    function setTheme(theme) {
      if (theme !== "light" && theme !== "dark") theme = "dark";
      document.body.dataset.theme = theme;
      const btn = document.getElementById("themeToggleBtn");
      if (btn) {
        btn.textContent =
          theme === "dark" ? "☀ Light mode" : "🌙 Dark mode";
      }
      localStorage.setItem(THEME_KEY, theme);
    }

    function toggleTheme() {
      const current = document.body.dataset.theme || "dark";
      setTheme(current === "dark" ? "light" : "dark");
    }

    function ensureLayoutShape() {
      for (let t = 1; t <= TERMS; t++) {
        const termKey = `term-${t}`;
        if (!state.layout[termKey]) state.layout[termKey] = {};
        for (let w = 1; w <= WEEKS_PER_TERM; w++) {
          const weekKey = `week-${w}`;
          if (!state.layout[termKey][weekKey]) {
            state.layout[termKey][weekKey] = {
              syllabus: [],
              textbook: [],
              resources: []
            };
          } else {
            const wk = state.layout[termKey][weekKey];
            wk.syllabus = Array.isArray(wk.syllabus) ? wk.syllabus : [];
            wk.textbook = Array.isArray(wk.textbook) ? wk.textbook : [];
            wk.resources = Array.isArray(wk.resources) ? wk.resources : [];
          }
        }
      }
      ["syllabus", "textbook", "resource"].forEach((k) => {
        if (!Array.isArray(state.backlog[k])) state.backlog[k] = [];
      });
      if (typeof state.resources !== "object" || !state.resources) {
        state.resources = {};
      }
    }

    function initState() {
      // init layout + default backlog
      for (let t = 1; t <= TERMS; t++) {
        const termKey = `term-${t}`;
        state.layout[termKey] = state.layout[termKey] || {};
        for (let w = 1; w <= WEEKS_PER_TERM; w++) {
          const weekKey = `week-${w}`;
          if (!state.layout[termKey][weekKey]) {
            state.layout[termKey][weekKey] = {
              syllabus: [],
              textbook: [],
              resources: []
            };
          }
        }
      }

      state.backlog.syllabus = SYLLABUS_OBJECTIVES.map((o) => o.id);
      state.backlog.textbook = TEXTBOOK_REFERENCES.map((t) => t.id);
      state.backlog.resource = [];

      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        // default filter = first topic
        const topics = Array.from(
          new Set(SYLLABUS_OBJECTIVES.map((o) => o.topic))
        );
        state.syllabusTopicFilter = topics[0] || null;
        return;
      }
      try {
        const saved = JSON.parse(raw);
        if (!saved || typeof saved !== "object") return;
        state.currentTerm = saved.currentTerm || 1;
        if (saved.layout) state.layout = saved.layout;
        if (saved.backlog) state.backlog = saved.backlog;
        if (saved.resources) state.resources = saved.resources;
        if (typeof saved.nextResourceId === "number") {
          state.nextResourceId = saved.nextResourceId;
        }
        if (saved.syllabusTopicFilter) {
          state.syllabusTopicFilter = saved.syllabusTopicFilter;
        } else {
          const topics = Array.from(
            new Set(SYLLABUS_OBJECTIVES.map((o) => o.topic))
          );
          state.syllabusTopicFilter = topics[0] || null;
        }
      } catch (e) {
        console.warn("Could not parse saved layout", e);
        const topics = Array.from(
          new Set(SYLLABUS_OBJECTIVES.map((o) => o.topic))
        );
        state.syllabusTopicFilter = topics[0] || null;
      }
    }

    function persistState() {
      const payload = {
        currentTerm: state.currentTerm,
        layout: state.layout,
        backlog: state.backlog,
        resources: state.resources,
        nextResourceId: state.nextResourceId,
        syllabusTopicFilter: state.syllabusTopicFilter
      };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      } catch (e) {
        console.warn("Could not save layout", e);
      }
    }

    /**********************************************************
     * BUILD UI
     **********************************************************/
    function buildTermTabs() {
      const tabsContainer = document.getElementById("termTabs");
      tabsContainer.innerHTML = "";
      for (let t = 1; t <= TERMS; t++) {
        const btn = document.createElement("button");
        btn.className = "term-tab" + (t === state.currentTerm ? " active" : "");
        btn.textContent = `Term ${t}`;
        btn.dataset.term = String(t);
        btn.addEventListener("click", () => {
          state.currentTerm = t;
          document
            .querySelectorAll(".term-tab")
            .forEach((el) => el.classList.remove("active"));
          btn.classList.add("active");
          renderPlanner();
          updateSummaryLabel();
          document.getElementById(
            "currentTermLabel"
          ).textContent = `Term ${state.currentTerm}`;
          persistState();
        });
        tabsContainer.appendChild(btn);
      }
      document.getElementById(
        "currentTermLabel"
      ).textContent = `Term ${state.currentTerm}`;
    }

    function buildSyllabusTopicTabs() {
      const container = document.getElementById("syllabusTopicTabs");
      container.innerHTML = "";
      const topics = Array.from(
        new Set(SYLLABUS_OBJECTIVES.map((o) => o.topic))
      );
      if (!state.syllabusTopicFilter) {
        state.syllabusTopicFilter = topics[0] || null;
      }
      topics.forEach((topic) => {
        const btn = document.createElement("button");
        btn.className =
          "syllabus-topic-tab" +
          (topic === state.syllabusTopicFilter ? " active" : "");
        btn.textContent = topic;
        btn.addEventListener("click", () => {
          state.syllabusTopicFilter = topic;
          document
            .querySelectorAll(".syllabus-topic-tab")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          renderBacklogs(); // re-filter backlog
          persistState();
        });
        container.appendChild(btn);
      });
    }

    function buildPlanner() {
      const plannerGrid = document.getElementById("plannerGrid");
      plannerGrid.innerHTML = "";
      for (let w = 1; w <= WEEKS_PER_TERM; w++) {
        const weekKey = `week-${w}`;
        const row = document.createElement("div");
        row.className = "week-row";
        row.dataset.weekKey = weekKey;

        const header = document.createElement("div");
        header.className = "week-header";
        const name = document.createElement("div");
        name.className = "week-name";
        name.textContent = `Week ${w}`;
        const count = document.createElement("div");
        count.className = "week-count";
        count.id = `week-count-${weekKey}`;
        count.textContent = "0 items";
        header.appendChild(name);
        header.appendChild(count);

        const slotsRow = document.createElement("div");
        slotsRow.className = "week-slots-row";

        const syllabusSlot = createSlot(
          "Syllabus objectives",
          "syllabus",
          weekKey
        );
        const textbookSlot = createSlot(
          "Textbook references",
          "textbook",
          weekKey
        );
        const resourceSlot = createSlot(
          "Additional resources / information",
          "resources",
          weekKey
        );

        slotsRow.appendChild(syllabusSlot);
        slotsRow.appendChild(textbookSlot);
        slotsRow.appendChild(resourceSlot);

        row.appendChild(header);
        row.appendChild(slotsRow);
        plannerGrid.appendChild(row);
      }
    }

    function createSlot(title, slotType, weekKey) {
      const slot = document.createElement("div");
      slot.className = "slot";

      const header = document.createElement("div");
      header.className = "slot-header";
      const titleEl = document.createElement("div");
      titleEl.className = "slot-title";
      titleEl.textContent = title;
      const chip = document.createElement("div");
      chip.className = "slot-chip";
      chip.textContent =
        slotType === "syllabus"
          ? "Syllabus cards only"
          : slotType === "textbook"
          ? "Textbook cards only"
          : "Resource cards";
      header.appendChild(titleEl);
      header.appendChild(chip);

      const dz = document.createElement("div");
      dz.className = "slot-dropzone";
      dz.dataset.locationType = "week";
      dz.dataset.weekKey = weekKey;
      dz.dataset.slotType = slotType;
      dz.dataset.acceptType =
        slotType === "syllabus"
          ? "syllabus"
          : slotType === "textbook"
          ? "textbook"
          : "resource";
      enableDropzone(dz);

      slot.appendChild(header);
      slot.appendChild(dz);
      return slot;
    }

    function buildBacklogs() {
      enableDropzone(document.getElementById("syllabusBacklog"));
      enableDropzone(document.getElementById("textbookBacklog"));
      enableDropzone(document.getElementById("resourceBacklog"));
    }

    /**********************************************************
     * RENDERING
     **********************************************************/
    function renderAll() {
      renderBacklogs();
      renderPlanner();
      updateSummaryLabel();
      retypesetMath();
    }

    function renderBacklogs() {
      const syllabusBacklog = document.getElementById("syllabusBacklog");
      const textbookBacklog = document.getElementById("textbookBacklog");
      const resourceBacklog = document.getElementById("resourceBacklog");

      syllabusBacklog.innerHTML = "";
      textbookBacklog.innerHTML = "";
      resourceBacklog.innerHTML = "";

      // Ensure we have a valid filter
      const allTopics = Array.from(
        new Set(SYLLABUS_OBJECTIVES.map((o) => o.topic))
      );
      if (!state.syllabusTopicFilter) {
        state.syllabusTopicFilter = allTopics[0] || null;
      }

      // Filter syllabus backlog by selected topic
      state.backlog.syllabus.forEach((id) => {
        const obj = SYLLABUS_OBJECTIVES.find((o) => o.id === id);
        if (!obj) return;
        if (obj.topic === state.syllabusTopicFilter) {
          syllabusBacklog.appendChild(createCard(obj, "syllabus"));
        }
      });

      // Textbook backlog – all unassigned
      state.backlog.textbook.forEach((id) => {
        const ref = TEXTBOOK_REFERENCES.find((t) => t.id === id);
        if (ref) textbookBacklog.appendChild(createCard(ref, "textbook"));
      });

      // Resource backlog – all unassigned
      state.backlog.resource.forEach((id) => {
        const res = findResourceCard(id);
        if (res) resourceBacklog.appendChild(createCard(res, "resource"));
      });

      // Counts (total unassigned, not per-topic)
      document.getElementById(
        "syllabusBacklogCount"
      ).textContent = `${state.backlog.syllabus.length} unassigned`;
      document.getElementById(
        "textbookBacklogCount"
      ).textContent = `${state.backlog.textbook.length} unassigned`;
      document.getElementById(
        "resourceBacklogCount"
      ).textContent = `${state.backlog.resource.length} unassigned`;
      retypesetMath();
    }

    function renderPlanner() {
      document.querySelectorAll(".slot-dropzone").forEach((dz) => {
        dz.innerHTML = "";
      });

      const termKey = `term-${state.currentTerm}`;
      const termLayout = state.layout[termKey];

      for (let w = 1; w <= WEEKS_PER_TERM; w++) {
        const weekKey = `week-${w}`;
        const layout = termLayout[weekKey];

        const sylDz = document.querySelector(
          `.slot-dropzone[data-week-key="${weekKey}"][data-slot-type="syllabus"]`
        );
        const tbDz = document.querySelector(
          `.slot-dropzone[data-week-key="${weekKey}"][data-slot-type="textbook"]`
        );
        const resDz = document.querySelector(
          `.slot-dropzone[data-week-key="${weekKey}"][data-slot-type="resources"]`
        );

        layout.syllabus.forEach((id) => {
          const obj = SYLLABUS_OBJECTIVES.find((o) => o.id === id);
          if (obj && sylDz) sylDz.appendChild(createCard(obj, "syllabus"));
        });

        layout.textbook.forEach((id) => {
          const ref = TEXTBOOK_REFERENCES.find((t) => t.id === id);
          if (ref && tbDz) tbDz.appendChild(createCard(ref, "textbook"));
        });

        layout.resources.forEach((id) => {
          const res = findResourceCard(id);
          if (res && resDz) resDz.appendChild(createCard(res, "resource"));
        });

        const countEl = document.getElementById(`week-count-${weekKey}`);
        if (countEl) {
          const count =
            layout.syllabus.length +
            layout.textbook.length +
            layout.resources.length;
          countEl.textContent = `${count} item${count === 1 ? "" : "s"}`;
        }
      }

      document.getElementById(
        "currentTermLabel"
      ).textContent = `Term ${state.currentTerm}`;
      retypesetMath();
    }

    function updateSummaryLabel() {
      let placedSyllabus = 0;
      let placedTextbook = 0;
      let placedResources = 0;

      for (let t = 1; t <= TERMS; t++) {
        const termKey = `term-${t}`;
        for (let w = 1; w <= WEEKS_PER_TERM; w++) {
          const weekKey = `week-${w}`;
          const week = state.layout[termKey][weekKey];
          placedSyllabus += week.syllabus.length;
          placedTextbook += week.textbook.length;
          placedResources += week.resources.length;
        }
      }

      const totalSyllabus = SYLLABUS_OBJECTIVES.length;
      const totalTextbook = TEXTBOOK_REFERENCES.length;

      const label = document.getElementById("summaryLabel");
      label.textContent =
        `${placedSyllabus}/${totalSyllabus} syllabus, ` +
        `${placedTextbook}/${totalTextbook} textbook, ` +
        `${placedResources} resource notes placed`;
    }

    function retypesetMath() {
      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise();
      }
    }

    /**********************************************************
     * UTIL – topic slug for CSS class
     **********************************************************/
    function topicSlug(topic) {
      if (!topic) return "unknown";
      return topic.toLowerCase().replace(/[^a-z0-9]+/g, "-");
    }

    /**********************************************************
     * CARD CREATION
     **********************************************************/
    function createCard(data, type) {
      const card = document.createElement("article");
      card.className = "card";
      card.draggable = true;
      card.dataset.cardId = data.id;
      card.dataset.cardType = type;

      const tagRow = document.createElement("div");
      tagRow.className = "card-tag-row";

      const tag = document.createElement("div");
      tag.className = `card-tag ${type}`;
      const dot = document.createElement("span");
      dot.className = "dot";
      const label = document.createElement("span");
      label.className = "card-tag-label";
      if (type === "syllabus") label.textContent = data.section || "Syllabus";
      else if (type === "textbook") label.textContent = "Textbook";
      else label.textContent = "Resource";

      tag.appendChild(dot);
      tag.appendChild(label);

      const pill = document.createElement("div");
      pill.className = "pill";

      if (type === "syllabus") {
        pill.classList.add("pill-syllabus");
        const slug = topicSlug(data.topic);
        pill.classList.add(`topic-${slug}`);
        pill.textContent = data.topic || "AA Syllabus";
      } else if (type === "textbook") {
        pill.classList.add("pill-textbook");
        pill.textContent = "Text reference";
      } else {
        pill.classList.add("pill-resource");
        pill.textContent = "Note";
      }

      tagRow.appendChild(tag);
      tagRow.appendChild(pill);

      const main = document.createElement("div");
      main.className = "card-main";
      if (type === "syllabus") {
        main.innerHTML = `<strong>${data.section}</strong> — ${data.text}`;
      } else if (type === "textbook") {
        main.innerHTML = `<strong>${data.label}</strong>`;
      } else {
        main.innerHTML = `<strong>${data.title}</strong>`;
      }

      const sub = document.createElement("div");
      sub.className = "card-sub";

      if (type === "syllabus") {
        sub.textContent = "";
      } else if (type === "textbook") {
        const parts = [];
        if (data.detail) parts.push(data.detail);
        if (data.url) {
          parts.push(
            `<a href="${data.url}" target="_blank" rel="noopener noreferrer">Exercises ↗</a>`
          );
        }
        sub.innerHTML = parts.join(" · ");
      } else {
        sub.textContent = data.detail || "";
      }

      card.appendChild(tagRow);
      card.appendChild(main);
      if (sub.textContent.trim() !== "" || sub.innerHTML.trim() !== "") {
        card.appendChild(sub);
      }

      card.addEventListener("dragstart", handleDragStart);
      card.addEventListener("dragend", handleDragEnd);

      return card;
    }

    /**********************************************************
     * RESOURCE CARDS
     **********************************************************/
    function createNewResourceNote() {
      const title = prompt("Resource / note title:");
      if (!title) return;
      const detail =
        prompt(
          "Optional details / link / description (LaTeX allowed, eg $y=mx+c$):"
        ) || "";
      const id = `res-${state.nextResourceId++}`;
      state.resources[id] = { id, title, detail };
      state.backlog.resource.push(id);
      persistState();
      renderBacklogs();
      updateSummaryLabel();
      retypesetMath();
    }

    function findResourceCard(id) {
      return state.resources[id];
    }

    /**********************************************************
     * DRAG & DROP + REORDERING
     **********************************************************/
    let currentDrag = null;

    function handleDragStart(e) {
      const id = this.dataset.cardId;
      const type = this.dataset.cardType;
      currentDrag = { id, type };
      this.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/plain", JSON.stringify({ id, type }));
    }

    function handleDragEnd() {
      this.classList.remove("dragging");
      currentDrag = null;
    }

    function enableDropzone(dz) {
      dz.addEventListener("dragover", (e) => {
        e.preventDefault();
        const acceptType = dz.dataset.acceptType;
        const dragType = currentDrag && currentDrag.type;
        if (acceptType && dragType && acceptType !== dragType) {
          e.dataTransfer.dropEffect = "none";
          dz.classList.remove("is-over");
          return;
        }
        e.dataTransfer.dropEffect = "move";
        dz.classList.add("is-over");
      });

      dz.addEventListener("dragleave", () => {
        dz.classList.remove("is-over");
      });

      dz.addEventListener("drop", (e) => {
        e.preventDefault();
        dz.classList.remove("is-over");
        const dataStr = e.dataTransfer.getData("text/plain");
        if (!dataStr) return;
        let payload;
        try {
          payload = JSON.parse(dataStr);
        } catch {
          return;
        }
        const { id, type } = payload;
        const acceptType = dz.dataset.acceptType;
        if (acceptType && type !== acceptType) return;

        const posInfo = getDropPositionInfo(dz, e.clientY, id);
        moveCardToDropzone(id, type, dz, posInfo);
      });
    }

    // Decide where in the list the card should go, based on mouse Y
    function getDropPositionInfo(dz, clientY, movingId) {
      const cards = Array.from(dz.querySelectorAll(".card")).filter(
        (c) => c.dataset.cardId !== movingId
      );
      const ids = cards.map((c) => c.dataset.cardId);
      let index = ids.length;
      for (let i = 0; i < cards.length; i++) {
        const rect = cards[i].getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        if (clientY < midY) {
          index = i;
          break;
        }
      }
      return { index, ids };
    }

    function moveCardToDropzone(id, type, dz, posInfo) {
      // Remove from backlogs
      ["syllabus", "textbook", "resource"].forEach((kind) => {
        state.backlog[kind] = state.backlog[kind].filter((x) => x !== id);
      });

      // Remove from all week layouts
      for (let t = 1; t <= TERMS; t++) {
        const termKey = `term-${t}`;
        for (let w = 1; w <= WEEKS_PER_TERM; w++) {
          const weekKey = `week-${w}`;
          const week = state.layout[termKey][weekKey];
          week.syllabus = week.syllabus.filter((x) => x !== id);
          week.textbook = week.textbook.filter((x) => x !== id);
          week.resources = week.resources.filter((x) => x !== id);
        }
      }

      const { index, ids } = posInfo;
      const locType = dz.dataset.locationType;

      if (locType === "backlog") {
        // Reorder within the visible subset (current filter), but keep
        // other backlog items (from other topics) in their existing order
        const visibleOther = ids; // cards currently visible in this backlog
        const visibleFinal = visibleOther.slice();
        visibleFinal.splice(index, 0, id);

        const old = state.backlog[type];
        const invisible = old.filter(
          (x) => !visibleOther.includes(x) && x !== id
        );
        state.backlog[type] = visibleFinal.concat(invisible);
      } else if (locType === "week") {
        const weekKey = dz.dataset.weekKey;
        const slotType = dz.dataset.slotType;
        const termKey = `term-${state.currentTerm}`;
        const week = state.layout[termKey][weekKey];

        const visibleFinal = ids.slice();
        visibleFinal.splice(index, 0, id);

        if (slotType === "syllabus") week.syllabus = visibleFinal;
        else if (slotType === "textbook") week.textbook = visibleFinal;
        else week.resources = visibleFinal;
      }

      persistState();
      renderAll();
    }

    /**********************************************************
     * EXPORT / IMPORT JSON
     **********************************************************/
    function exportJSON() {
      const exportObj = {
        version: 1,
        theme: document.body.dataset.theme || "dark",
        state: {
          currentTerm: state.currentTerm,
          layout: state.layout,
          backlog: state.backlog,
          resources: state.resources,
          nextResourceId: state.nextResourceId,
          syllabusTopicFilter: state.syllabusTopicFilter
        }
      };
      const blob = new Blob([JSON.stringify(exportObj, null, 2)], {
        type: "application/json"
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const dateStr = new Date().toISOString().slice(0, 10);
      a.href = url;
      a.download = `aa-topic1-planner-${dateStr}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function handleImportFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const obj = JSON.parse(e.target.result);
          applyImportedState(obj);
          alert("Import successful.");
        } catch (err) {
          console.error(err);
          alert("Could not import JSON – check the file format.");
        } finally {
          event.target.value = "";
        }
      };
      reader.readAsText(file);
    }

    function applyImportedState(importObj) {
      if (!importObj || typeof importObj !== "object") return;
      if (importObj.theme) setTheme(importObj.theme);

      if (importObj.state) {
        const s = importObj.state;
        if (s.layout) state.layout = s.layout;
        if (s.backlog) state.backlog = s.backlog;
        if (s.resources) state.resources = s.resources;
        if (typeof s.nextResourceId === "number") {
          state.nextResourceId = s.nextResourceId;
        }
        if (typeof s.currentTerm === "number") {
          state.currentTerm = s.currentTerm;
        }
        if (s.syllabusTopicFilter) {
          state.syllabusTopicFilter = s.syllabusTopicFilter;
        }
      }
      ensureLayoutShape();
      buildTermTabs();
      buildSyllabusTopicTabs();
      buildPlanner();
      renderAll();
      persistState();
    }

    /**********************************************************
     * CONTROLS
     **********************************************************/
    function wireControls() {
      document
        .getElementById("resetLayoutBtn")
        .addEventListener("click", () => {
          if (
            !confirm(
              "Reset the entire planner? All cards will be moved back to the backlog for every term."
            )
          ) {
            return;
          }
          state.currentTerm = 1;
          state.layout = {};
          state.backlog = {
            syllabus: SYLLABUS_OBJECTIVES.map((o) => o.id),
            textbook: TEXTBOOK_REFERENCES.map((t) => t.id),
            resource: []
          };
          state.resources = {};
          state.nextResourceId = 0;
          const topics = Array.from(
            new Set(SYLLABUS_OBJECTIVES.map((o) => o.topic))
          );
          state.syllabusTopicFilter = topics[0] || null;
          ensureLayoutShape();
          buildTermTabs();
          buildSyllabusTopicTabs();
          buildPlanner();
          renderAll();
          persistState();
        });

      document
        .getElementById("newResourceBtn")
        .addEventListener("click", createNewResourceNote);

      document
        .getElementById("themeToggleBtn")
        .addEventListener("click", toggleTheme);

      document.getElementById("exportBtn").addEventListener("click", exportJSON);

      const importInput = document.getElementById("importFileInput");
      document.getElementById("importBtn").addEventListener("click", () => {
        importInput.click();
      });
      importInput.addEventListener("change", handleImportFile);
    }
  </script>
</body>
</html>
